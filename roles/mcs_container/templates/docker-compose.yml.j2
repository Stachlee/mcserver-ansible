services:
  mc:
    image: itzg/minecraft-server
    container_name: mc_server
    ports:
      - "25565:25565"
    environment:
      EULA: "TRUE"
      # Version & Typ
      TYPE: "{{ mc_server_type }}"
      VERSION: "{{ mc_version }}"
      
      # Hardware & RAM
      MEMORY: "{{ mc_ram_max }}"
      INIT_MEMORY: "{{ mc_ram_init }}"
      # Performance Flags (Aiki-Flags)
      JVM_XX_OPTS: "-XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 -XX:G1HeapRegionSize=8M -XX:G1ReservePercent=20 -XX:G1HeapWastePercent=5 -XX:G1MixedGCCountTarget=4 -XX:InitiatingHeapOccupancyPercent=15 -XX:G1MixedGCLiveThresholdPercent=90 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:SurvivorRatio=32 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1"
      
      # Welt-Einstellungen
      DIFFICULTY: "{{ mc_difficulty }}"
      MOTD: "{{ mc_motd }}"
      VIEW_DISTANCE: "{{ mc_view_distance }}"
      ONLINE_MODE: "{{ mc_online_mode }}"
      
      # Whitelist
      ENABLE_WHITELIST: "{{ mc_whitelist_enabled }}"
      ENFORCE_WHITELIST: "{{ mc_enforce_whitelist }}"
      
      # RCON (Passwort kommt aus Vault)
      ENABLE_RCON: "true"
      RCON_PASSWORD: "{{ mc_rcon_password }}"
    volumes:
      - "{{ mc_data_dir }}:/data"
    restart: unless-stopped

  backup:
    image: itzg/mc-backup
    container_name: mc_backup
    environment:
      RCON_HOST: mc
      RCON_PASSWORD: "{{ mc_rcon_password }}"
      BACKUP_INTERVAL: "0 3 * * *"
      PRUNE_BACKUPS_DAYS: 7
    volumes:
      - "{{ mc_data_dir }}:/data:ro"
      - "{{ mc_root_dir }}/backups:/backups"
    restart: unless-stopped